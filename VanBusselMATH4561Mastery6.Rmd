---
title: "MATH4561 Mastery VI"
author: "Melissa Van Bussel"
date: "April 20, 2019"
output:
  pdf_document:
    highlight: zenburn
    latex_engine: lualatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
library(knitr)
library(kableExtra)
```

# Problem 1

A study was conducted to determine the effects of individual bathers on the fecal
and total coliform bacterial populations in water. The variables of interest were the time since the subject's last bath, the vigor of the subject's activity in the water, and the subject's sex. The experiments were perfomed in a 100-gallon polyethylene tub using dechlorinated tap water at 38 degrees Celsius. The bacterial contribution of each bather was determined by subtracting the bacterial concentration measured at 15 and 30 minutes from that measured initially. A replicated $2^3$ factorial design was used for
this experiment. (Note: Because the measurement of bacterial populations in water involves a dilution technique, the experimental errors do not have constant variance. Rather, the variation increases with the value of the mean.) Perform analysis using a logarithmic
transfomation of the data.

The variables of interest are:

- $x_1$: time since last bath, with levels 1-hour and 24-hours
- $x_2$: vigor of bathing activity, with levels Lethargic and Vigorous
- $x_3$: sex of bather, with levels Female and Male

The response variable is:

- $y_3$: Total coliform contribution after 15 minutes (organisms/100mL)

(a) Briefly explain why this is a $2^3$ factorial design.

(b) Calculate the factorial effects (main and interaction effects) on total coliform populations after 15 minutes. Interpret the main effect of $x_1$, and the interaction between $x_1$ and $x_3$. Ensure you model the logarithm of $y_3$.

```{r}
prb0506 <- read.table(file = "prb0506.dat",header = T)
```

# Problem 1: Solution

## 1 (a)

This is referred to as a $2^3$ factorial design because we have 3 factors, each of which have two levels. The first factor is time since last bath (levels: 1 hour or 24 hours), the second factor is vigor of bathing activity (levels: lethargic or vigorous), and the third factor is sex of bather (levels: male or female). The number of treatment combinations is $2^3 = 8$, which is where the name comes from. 

## 1 (b)

To estimate the effects, we can use the `lm` function.

```{r}
bath <- as.factor(prb0506$x1)
vigor <- as.factor(prb0506$x2)
sex <- as.factor(prb0506$x3)
response <- log(prb0506$y3)
coliform <- data.frame(bath, vigor, sex, response)
mod <- lm(response ~ bath*vigor*sex, data = coliform)
summary(mod)
```

The "effects" are simply the coefficients of the terms in the model. From the summary output, we can see which effects are significant. However, a more visual representation can also help with the interpretation. Recall that if all coefficients are insignificant, then they should come from a Normal distribution with mean 0 due to the Central Limit Theorem. Therefore, by creating a Normal Q-Q plot, we can see which effects and interactions are significant. Coefficients which fall along the straight line are insignificant (come from a Normal Distribution), and outliers are significant (do not come from a Normal Distribution). 

```{r}
library(daewr)
fullnormal(coef(mod)[-1], alpha=.025)
```

We can see from the plot that many of the points deviate from the line, indicating significant effects. The only terms which are insignifcant are the interaction terms `bath*sex`, `vigor*sex` and `bath*vigor*sex`. 

We can further visualize the interaction effects by using interaction plots. For this question, we are interested in the interaction between `bath` and `sex`: 

```{r}
with(coliform, (interaction.plot(bath, sex, response, type = "b", pch =
c(18,24), main = "Interaction Plot",
xlab = "bath", ylab = "Total coliform after 15 minutes")))
```

From this interaction plot, we observe that there is no significant interaction, since the lines are approximately parallel. This tells us that, on average, changing the experimental unit from a man to a woman has a similar effect on the response (total coliform after 15 minutes) when the experimental unit has bathed an hour ago compared to when they bathed 24 hours ago. Changing the level of the `sex` variable does not change the effect that the `bath` variable has on the response, and vice versa.  

However, since we are also interested in the `bath` variable for this question, we need to consider any terms in the model which involve this variable, including interaction terms. If there are significant interaction terms which involve the `bath` variable, then the coefficient on the `bath` variable cannot be interpreted separately / on its own. 

Recall that the `bath*vigor` interaction term was significant in our model. Thus, we cannot directly interpret the `bath` variable's coefficient without considering other terms. We can, however, take a look at the coefficient of the `bath` variable and make a more general statement about it. First, we need to know which level of this factor had a higher average response. 

```{r}
bath_neg <- mean(subset(coliform, bath == -1, select = response)$response)
bath_pos <- mean(subset(coliform, bath == 1, select = response)$response)
bath_neg
bath_pos
```

We can see that the mean coliform level is higher for `bath = 1`. We aren't told whether `bath = 1` corresponds to 1 hour or 24 hours, but it seems reasonable to assume that bathing more recently would correspond to less bacteria, so let's make the assumption (for the purpose of answering this question) that `bath = 1` corresponds to having taken a bath 24 hours ago, while `bath = -1` corresponds to having taken a bath 1 hour ago. 

```{r, echo=FALSE}
coeff <- mod$coefficients[2]
```

**If we pretend for a moment that there was no significant interaction term involving the `bath` variable, we would interpret this coefficient in the following way:** if the other factors are kept constant (vigor and sex), then changing the `bath` variable from `-1` to `1` will increase the log total coliform contribution after 15 minutes by an average of `r coeff`. For example, if we were to take a measurement of the total coliform after 15 minutes from a man doing vigorous exercise who bathed an hour ago (and take the log of the measurement), and then repeat the experiment but have the man not shower for 24 hours beforehand, then we would expect the measurement of total coliform after 15 minutes to increase by roughly $e^{3.138322}$. However, this is a very small increase, and is essentially negligible, as this factor was found to be insignificant. While this factor does have *some* effect on the total coliform measurement (since the coefficient is not 0), the effect is so small that it is not worth including in our final model. We always desire the simplest model possible (the parsimonious model), so we do not include variables which are found to be insignificant. 

**However**, there is a significant interaction term involving the `bath` variable, so we cannot interpret the coefficient directly like that. Rather, we can interpret the coefficient as being significant, meaning that, on average, experimental units who bathe 24 hours ago will affect / increase the response more than those who bathed an hour ago. We can't directly interpret the value of the coefficient itself, though, because we'd need to take other terms in the model into consideration.

# Problem 2 

Le Riche and Csima (1964) evaluated four hypnotic drugs and a placebo to determine
their effect on the quality of sleep in elderly patients. The treatment levels were labeled (A = Placebo, B = Ethchlorvynol, C = Glutethimide, D = Chloral hydrate, and E = Secobarbitol sodium). Elderly patients were given one of the capsules for five nights in succession and their quality of sleep was rated by a trained nurse on a 4-point scale (0 = poor to 3 = excellent) each night. An average score was calculated for each patient over the five nights in a week. Each patient received all five treatments in successive weeks. A Latin-square design was used to account for patient-to-patient differences and week-to-week effects. The design and the response (mean quality of sleep rating) are shown in the table attached.

| Patient | 1        | 2        | 3        | 4        | 5        |
| :------ | :------- | :------- | :------- | :------- | :------- |
| 1       | B (2.92) | E (2.43) | A (2.19) | C (2.71) | D (2.71) |
| 2       | D (2.86) | A (1.64) | E (3.02) | B (3.03) | C (3.03) |
| 3       | E (1.97) | B (2.50) | C (2.47) | D (2.65) | A (1.89) |
| 4       | A (1.99) | C (2.39) | D (2.37) | E (2.33) | B (2.71) |
| 5       | C (2.64) | D (2.31) | B (2.44) | A (1.89) | E (2.78) |

(a) What is the appropriate model for this data?

(b) Complete the ANOVA and determine if there are any significant differences among the treatments.

(c) Use an appropriate method to determine if there is a significant difference between the placebo and the average of the other drugs, and if there are significant differences among the four drugs.

# Problem 2: Solution

## 2 (a)

In this situation, we are treating each patient as a block, and we are using a Latin Square Design to randomly assign the treatment order of the 5 treatments in each "block". Our column blocking factor is time, while our row blocking factor is the patient. Our 5 treatment levels are A = Placebo, B = Ethchlorvynol, C = Glutethimide, D = Chloral hydrate, and E = Secobarbitol sodium. Therefore, our model is: 

$$
y_{ijk} = r_i + c_j + \tau_k + \epsilon_{ijk}
$$

where $r_i, \; i = 1,2,3,4,5$ is the row blocking effect, $c_j, \; j = 1,2,3,4,5$ is the column-blocking effect, $\tau_k, \; k=1,2,3,4,5$ is the treatment effect, and $\epsilon_{ijk}$ is the experimental error term. 

## 2 (b)

First, we import the data. 

| Patient | 1        | 2        | 3        | 4        | 5        |
| :------ | :------- | :------- | :------- | :------- | :------- |
| 1       | B (2.92) | E (2.43) | A (2.19) | C (2.71) | D (2.71) |
| 2       | D (2.86) | A (1.64) | E (3.02) | B (3.03) | C (3.03) |
| 3       | E (1.97) | B (2.50) | C (2.47) | D (2.65) | A (1.89) |
| 4       | A (1.99) | C (2.39) | D (2.37) | E (2.33) | B (2.71) |
| 5       | C (2.64) | D (2.31) | B (2.44) | A (1.89) | E (2.78) |

```{r}
patient <- as.factor(rep(1:5, each = 5))
week <- as.factor(rep(1:5, 5))
p1t <- c("B", "E", "A", "C", "D") # patient 1 treatment order
p2t <- c("D", "A", "E", "B", "C")
p3t <- c("E", "B", "C", "D", "A")
p4t <- c("A", "C", "D", "E", "B")
p5t <- c("C", "D", "B", "A", "E")
treatment <- as.factor(c(p1t, p2t, p3t, p4t, p5t))
p1r <- c(2.92, 2.43, 2.19, 2.71, 2.71) # patient 1 response
p2r <- c(2.86, 1.64, 3.02, 3.03, 3.03)
p3r <- c(1.97, 2.50, 2.47, 2.65, 1.89)
p4r <- c(1.99, 2.39, 2.37, 2.33, 2.71)
p5r <- c(2.64, 2.31, 2.44, 1.89, 2.78)
response <- c(p1r, p2r, p3r, p4r, p5r)
sleep <- data.frame(patient, week, treatment, response)
head(sleep)
```

Now, we can get the ANOVA table: 

```{r}
mod <- aov(response ~ patient + week + treatment)
summary(mod)
```

We can see from the summary of the model that the `treatment` variable is significant at significance level $\alpha = 0.001$. Therefore, we have strong evidence that there are some differences between the different treatment levels. 

## 2 (c)

To determine if there is a significant difference between the placebo and the average of the other drugs, we can use the following contrast: $\tau_1 - \frac{1}{4}(\tau_2 + \tau_3 + \tau_4 + \tau_5)$. We can also use boxplots to visualize the data. 

```{r}
con1 <- c(1, -1/4, -1/4, -1/4, -1/4)
library(gmodels)
fit.contrast(mod, "treatment", con1)
boxplot(response ~ treatment, data = sleep)
```

From both the `fit.contrast` output and the boxplots, we can see that there is a significant difference in sleep quality between the placebo and the average of the other treatments. In fact, the other treatments significantly increase the patient's quality of sleep. 

To determine if there are significant differences between the four drugs, we will have to use the Tukey Honestly Significant Differences methods. If we were only comparing a couple of the drugs, we would be able to continue using contrats; however, if we were to do all of the pairwise combinations, we would quickly run into orthogonality issues. This is demonstrated below: 

```{r}
con2 <- c(0, 1, -1, 0, 0)
con3 <- c(0, 1, 0, -1, 0)
con4 <- c(0, 1, 0, 0, -1)
con5 <- c(0, 0, 1, -1, 0)
con6 <- c(0, 0, 1, 0, -1)
con7 <- c(0, 0, 0, 1, -1)
(con1 %*% con2)[1, 1]
(con1 %*% con3)[1, 1] 
(con1 %*% con4)[1, 1]
(con1 %*% con5)[1, 1] 
(con1 %*% con6)[1, 1]
(con1 %*% con7)[1, 1]
(con2 %*% con3)[1, 1]
(con2 %*% con4)[1, 1] 
(con2 %*% con5)[1, 1] 
(con2 %*% con6)[1, 1] 
(con2 %*% con7)[1, 1] 
(con3 %*% con4)[1, 1] 
(con3 %*% con5)[1, 1] 
(con3 %*% con6)[1, 1] 
(con3 %*% con6)[1, 1] 
(con4 %*% con5)[1, 1] 
(con4 %*% con6)[1, 1] 
(con4 %*% con7)[1, 1]
(con5 %*% con6)[1, 1] 
(con5 %*% con7)[1, 1]
(con6 %*% con7)[1, 1]
```

So, instead, we use the `TukeyHSD` function. 

```{r}
TukeyHSD(mod, which = "treatment")
```

From this, we can see that there is a significant difference in sleep quality between the placebo and each of the other treatments. There is no significant difference in sleep quality between any pairs of the drugs. Thus, so long as a patient takes one of the hypnotic drugs (doesn't matter which one), they should, on average, see an increase in their sleep quality. 

# Problem 3

A wooden catapult can be used to flip a foam ball. The catapult has three factors that can be adjusted: the start angle, the stop angle, and the pivot height. The distance the ball travels can be measured with a tape measure.

(a) If experiments were to be conducted with the catapult by flipping the ball and measuring the distance, what would the experimental unit be?

(b) Using the numbers 1, 2, and 3 to represent the levels of start angle and stop angle, and holding the pivot height constant at its high level, make a randomized list of experiments for a 3 X 3 factorial experiment with $r = 2$ replicates per cell.

# Problem 3: Solution

## 3 (a) 

**Recall, from Lawson**: *Experimental Unit* is the item under study upon which something is changed.

In our case, the item under study / the experimental unit is the distance of the catapulted ball, given the start angle, stop angle, and pivot height. 

## 3 (b) 

We are told to keep the pivot height constant, so we are only really varying two factors, each with 3 levels. Thus, we have a 3 x 3 factorial design. We need to use the `expand.grid` function on two vectors which each contain 3 levels, and then we can combine these results with a constant pivot height and a randomized order to obtain our final randomization plan.  

```{r}
start <- 1:3
stop <- 1:3 
combos <- expand.grid(start, stop)
start <- rep(combos$Var1, 2) 
stop <- rep(combos$Var2, 2)
replicate <- rep(1:2, each = 9)
pivot <- rep(3, 18)
order <- sample(1:18, 18, replace = FALSE)
catapult <- data.frame(start, stop, pivot, replicate, order)
kable(catapult, "latex", booktabs = TRUE) %>%
  kable_styling(latex_options = "striped")
```



